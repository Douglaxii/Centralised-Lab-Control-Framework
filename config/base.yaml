# Base Configuration
# Core settings shared across all environments
# This file contains the foundation configuration that can be overridden
# by environment-specific files in the environments/ directory

---
# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================
network:
  # IP Addresses
  master_ip: "134.99.120.40"      # Camera/Master PC
  bind_host: "127.0.0.1"          # Default bind address for services
  
  # ZMQ Ports
  cmd_port: 5555                  # Master -> Worker commands (PUB/SUB)
  data_port: 5556                 # Worker -> Master data (PUSH/PULL)
  client_port: 5557               # Flask -> Manager (REQ/REP)
  camera_port: 5558               # Camera server (TCP socket)
  
  # Timeouts (seconds)
  connection_timeout: 5.0
  receive_timeout: 1.0
  watchdog_timeout: 60.0
  heartbeat_interval: 10.0
  
  # Retry settings
  max_retries: 5
  retry_base_delay: 1.0


# ============================================================================
# PATHS CONFIGURATION
# ============================================================================
paths:
  # Base paths
  artiq_data: "C:/artiq-master/results"
  output_base: "Y:/Xi/Data"
  
  # LabVIEW TDMS data paths (LabVIEW writes to these locations)
  labview_tdms: "Y:/Xi/Data/PMT"
  labview_telemetry: "Y:/Xi/Data/telemetry"
  
  # Camera data paths
  camera_frames: "Y:/Xi/Data/camera/raw_frames"
  camera_settings: "Y:/Xi/Data/camera/settings"
  camera_dcimg: "Y:/Xi/Data/camera/dcimg"
  live_frames: "Y:/Xi/Data/camera/live_frames"
  
  # Processed camera data (local drive for performance)
  jpg_frames: "E:/Data/jpg_frames"
  jpg_frames_labelled: "E:/Data/jpg_frames_labelled"
  ion_data: "E:/Data/ion_data"
  
  # Experiment and analysis data
  experiments: "Y:/Xi/Data/experiments"
  analysis_results: "Y:/Xi/Data/analysis/results"
  analysis_settings: "Y:/Xi/Data/analysis/settings"
  
  # Settings and debug paths
  dac_settings: "artiq/Settings/DAC/2944_dac_diff_fits.json"
  debug_path: "Y:/Xi/Data/debug"


# ============================================================================
# HARDWARE DEFAULTS
# ============================================================================
hardware:
  # ARTIQ Worker safe defaults
  worker_defaults:
    # DC electrode voltages (-1V to 50V range)
    ec1: 0.0
    ec2: 0.0
    comp_h: 0.0
    comp_v: 0.0
    
    # RF Voltage (U_RF in volts after amplifier)
    # LabVIEW sends u_rf in mV (0-1400mV), scale: 700mV = 100V
    u_rf_volts: 200.0
    
    # Piezo voltage for laser frequency tuning (0-4V range)
    piezo: 0.0
    
    # Raman laser frequencies (MHz)
    freq0: 215.5
    freq1: 215.5
    
    # Raman amplitudes (0-1)
    amp0: 0.05
    amp1: 0.05
    
    # Cooling shutters (0=off, 1=on)
    sw0: 0
    sw1: 0
    
    # Device toggles (0=off, 1=on)
    bephi: 0
    b_field: 1
    be_oven: 0
    uv3: 0
    e_gun: 0
    
    # Sweep parameters
    sweep_target: 307        # kHz
    sweep_span: 40.0         # Total span +/- 20kHz
    sweep_att: 25.0          # dB
    sweep_on: 300.0          # ms
    sweep_off: 300.0         # ms
    sweep_points: 41         # int

  # Camera hardware settings
  camera:
    target_temperature: -20.0      # Celsius
    cooler_timeout: 300            # seconds
    max_frames_default: 100
    exposure_default: 0.3
    trigger_mode: "extern"         # "extern" or "software"
    trigger_delay: 0.033138        # seconds
    
    # Subarray settings
    subarray:
      hsize: 300
      hpos: 1624
      vsize: 600
      vpos: 1396


# ============================================================================
# LABVIEW INTEGRATION
# ============================================================================
labview:
  enabled: true
  host: "172.17.1.217"           # LabVIEW PC IP (SMILE computer)
  port: 5559
  timeout: 5.0
  retry_delay: 1.0
  max_retries: 3
  auto_reconnect: true
  
  # Pressure safety configuration
  pressure_threshold_mbar: 5.0e-9    # 5 x 10^-9 mbar threshold
  pressure_check_interval: 0.05      # 20 Hz check rate
  
  # Supported devices (must match LabVIEW implementation)
  devices:
    - u_rf
    - piezo
    - be_oven
    - b_field
    - bephi
    - uv3
    - e_gun
    - hd_valve
    - dds


# ============================================================================
# TELEMETRY
# ============================================================================
telemetry:
  enabled: true
  path: "Y:/Xi/Data/telemetry"
  poll_interval: 1.0
  max_points: 1000
  window_seconds: 300
  
  # TDMS files (LabVIEW writes to Y:/Xi/Data/PMT/)
  tdms_path: "Y:/Xi/Data/PMT"
  tdms_extension: ".tdms"


# ============================================================================
# CAMERA CONTROL
# ============================================================================
camera:
  auto_start: true
  mode: "inf"                    # "inf" for infinite, "single" for DCIMG
  send_initial_trigger: true
  
  host: "127.0.0.1"
  port: 5558
  
  # Frame storage paths
  raw_frames_path: "E:/Data/jpg_frames"
  labelled_frames_path: "E:/Data/jpg_frames_labelled"
  ion_data_path: "E:/Data/ion_data"
  
  # Infinite mode settings
  infinite_mode:
    max_frames: 100
    exposure_ms: 300
    trigger_mode: "software"
  
  # Image processing settings
  processing:
    enabled: true
    roi: [180, 220, 425, 495]    # [x_start, x_finish, y_start, y_finish]
    filter_radius: 6
    threshold_sigma: 3.0
    max_ions: 5
  
  # HTTP API (Flask server)
  flask_base_url: "http://127.0.0.1:5000"


# ============================================================================
# LOGGING
# ============================================================================
logging:
  level: "INFO"
  format: "%(asctime)s - [%(name)s] - %(levelname)s - %(message)s"
  file_rotation:
    max_bytes: 1048576      # 1MB
    backup_count: 5
  
  # Component log files
  files:
    manager: "Y:/Xi/Data/logs/manager.log"
    worker: "Y:/Xi/Data/logs/artiq_worker.log"
    camera: "Y:/Xi/Data/logs/camera.log"
    analysis: "Y:/Xi/Data/logs/analysis.log"


# ============================================================================
# ANALYSIS
# ============================================================================
analysis:
  # Sweep analysis
  sweep:
    model: "lorentzian"
    initial_guess:
      gamma: 5000.0          # 5 kHz
  
  # Image handler configuration
  image_handler:
    roi:
      x_start: 0
      x_finish: 500
      y_start: 10
      y_finish: 300
    
    detection:
      threshold_percentile: 99.5
      min_snr: 6.0
      min_intensity: 35
      max_intensity: 65000
      min_sigma: 2.0
      max_sigma: 30.0
      max_ions: 10
      min_distance: 15
      edge_margin: 20
      bg_kernel_size: 15
      scales: [3, 5, 7]
    
    visualization:
      panel_height_ratio: 0.25
      font_scale_title: 0.4
      font_scale_data: 0.32
      font_scale_ion_num: 0.45
      crosshair_size: 12
      circle_radius_factor: 1.5
    
    performance:
      num_threads: 8
      use_vectorized: true
      use_gpu: true
      jpeg_quality: 85


# ============================================================================
# EXPERIMENT
# ============================================================================
experiment:
  auto_generate_id: true
  id_prefix: "EXP"
  save_metadata: true
  max_frames_keep: 100
  cleanup_interval: 5
