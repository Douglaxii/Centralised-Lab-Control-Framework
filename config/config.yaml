# MLS Configuration File
# Single unified configuration for Camera, Manager, Flask, Turbo, and Applets
#
# Usage:
#   from src.core.config import get_config
#   config = get_config()
#
# Environment Selection:
#   Set MLS_ENV environment variable:
#   - MLS_ENV=development  (laptop/local testing)
#   - MLS_ENV=production   (lab/manager PC)

---
# =============================================================================
# ACTIVE ENVIRONMENT
# =============================================================================
# Set to 'development' for laptop testing, 'production' for lab
environment: development


# =============================================================================
# PROFILES
# =============================================================================
profiles:

  # ============================================================================
  # DEVELOPMENT PROFILE (Laptop/Local Testing)
  # ============================================================================
  development:
    description: "Local development on laptop"

    # -------------------------------------------------------------------------
    # Network Configuration
    # -------------------------------------------------------------------------
    network:
      # IP Addresses
      master_ip: "192.168.56.101"     # ARTIQ VM IP
      bind_host: "127.0.0.1"          # Local only
      
      # ZMQ Ports
      cmd_port: 5555                  # Manager -> ARTIQ commands
      data_port: 5556                 # ARTIQ -> Manager data
      client_port: 5557               # Flask -> Manager requests
      camera_port: 5558               # Camera server
      
      # Timeouts (seconds)
      connection_timeout: 5.0
      receive_timeout: 1.0
      heartbeat_interval: 10.0
      
      # Retry settings
      max_retries: 3
      retry_base_delay: 1.0

    # -------------------------------------------------------------------------
    # Services Configuration
    # -------------------------------------------------------------------------
    services:
      # Flask Web Server
      flask:
        enabled: true
        host: "127.0.0.1"
        port: 5000
        threaded: true
        debug: true
      
      # Control Manager
      manager:
        enabled: true
        host: "127.0.0.1"
        max_worker_threads: 4
      
      # Camera Server
      camera:
        enabled: true
        host: "127.0.0.1"
        port: 5558
        auto_start: false           # Don't auto-start in dev
        mode: "inf"                 # "inf" or "single"
      
      # Optimizer (TuRBO/MOBO)
      optimizer:
        enabled: true
        host: "127.0.0.1"
        port: 5050
      
      # Applets
      applet:
        enabled: true
        host: "127.0.0.1"
        port: 5051

    # -------------------------------------------------------------------------
    # Data Paths
    # -------------------------------------------------------------------------
    paths:
      base: "./data"
      output_base: "./data"          # Backward compatibility
      
      # Camera data (only two folders needed)
      jpg_frames: "./data/jpg_frames"
      jpg_frames_labelled: "./data/jpg_frames_labelled"
      
      # Experiment data
      experiments: "./data/experiments"
      analysis: "./data/analysis"
      
      # Logs
      logs: "./logs"
      
      # ARTIQ
      artiq_results: "./data/artiq"
      dac_settings: "artiq/Settings/DAC/2944_dac_diff_fits.json"

    # -------------------------------------------------------------------------
    # Hardware Settings
    # -------------------------------------------------------------------------
    hardware:
      # Default voltage/parameters for ARTIQ worker
      defaults:
        # DC Electrodes (Volts, -1 to 50)
        ec1: 0.0
        ec2: 0.0
        comp_h: 0.0
        comp_v: 0.0
        
        # RF Voltage (Volts, 0 to 200)
        u_rf_volts: 100.0
        
        # Piezo (Volts, 0 to 4)
        piezo: 0.0
        
        # DDS/Raman (MHz)
        freq0: 215.5
        freq1: 215.5
        amp0: 0.05
        amp1: 0.05
        sw0: 0
        sw1: 0
        
        # Toggles (0=off, 1=on)
        bephi: 0
        b_field: 1
        be_oven: 0
        uv3: 0
        e_gun: 0
        
        # Sweep parameters
        sweep_target: 307        # kHz
        sweep_span: 40.0         # kHz
        sweep_att: 25.0          # dB
        sweep_on: 300.0          # ms
        sweep_off: 300.0         # ms
        sweep_points: 41
      
      # Camera hardware
      camera:
        model: "C15550-20UP"     # Hamamatsu ORCA-Quest
        sensor_size: [2048, 2048]
        bit_depth: 16
        cooling: -10.0           # Celsius
        
        # Acquisition defaults
        exposure_ms: 300
        trigger_mode: "software"  # "software" or "extern"
        max_frames: 100
        
        # ROI (Region of Interest)
        roi: [0, 500, 10, 300]   # [x_start, x_finish, y_start, y_finish]
        
        # Image processing
        processing:
          enabled: true
          filter_radius: 6
          threshold_sigma: 3.0
          max_ions: 5

    # -------------------------------------------------------------------------
    # LabVIEW Integration (Disabled in dev)
    # -------------------------------------------------------------------------
    labview:
      enabled: false
      host: "127.0.0.1"
      port: 5559
      timeout: 5.0
      
      # Communication mode:
      # - true: Two-way, wait for response from LabVIEW
      # - false: One-way (fire-and-forget), LabVIEW only receives commands
      wait_for_response: false
      
      # Pressure safety
      pressure_threshold_mbar: 5.0e-9
      pressure_check_interval: 0.05
      
      # Available devices
      devices:
        - u_rf
        - piezo
        - be_oven
        - b_field
        - bephi
        - uv3
        - e_gun
        - hd_valve
        - dds

    # -------------------------------------------------------------------------
    # Wavemeter (HighFinesse WS7)
    # -------------------------------------------------------------------------
    wavemeter:
      enabled: false
      host: "134.99.120.141"
      port: 1790
      divider: 4.0
      
      fundamental_range: [200, 260]
      uv_range: [900, 980]
      
      display_unit: "GHz"
      precision: 3

    # -------------------------------------------------------------------------
    # Turbo/Optimizer Settings
    # -------------------------------------------------------------------------
    optimizer:
      # TuRBO (Phase I) settings
      turbo:
        max_iterations: 100
        batch_size: 1
        num_restarts: 10
        raw_samples: 512
        
        # Trust region parameters
        tr_length_init: 0.8
        tr_length_min: 0.01
        tr_length_max: 1.6
        failure_tolerance: 5
        success_tolerance: 3
      
      # MOBO (Phase II) settings
      mobo:
        max_iterations: 50
        batch_size: 1
        num_restarts: 10
        raw_samples: 256
        
        # Multi-objective
        ref_point: [0.0, 100.0]    # Reference point for Pareto front
        
      # Two-phase controller
      two_phase:
        phase1_iterations: 30
        phase2_iterations: 20
        warm_start: true

    # -------------------------------------------------------------------------
    # Applet Settings
    # -------------------------------------------------------------------------
    applet:
      # Auto-compensation applet
      auto_comp:
        enabled: true
        max_iterations: 50
        convergence_threshold: 0.01
      
      # Camera sweep applet
      cam_sweep:
        enabled: true
        default_exposure_ms: 100
        default_frames: 10
      
      # Secular sweep applet
      secular_sweep:
        enabled: true
        default_span_khz: 40
        default_steps: 41

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    logging:
      level: "DEBUG"
      format: "%(asctime)s - [%(name)s] - %(levelname)s - %(message)s"
      
      # Log files
      files:
        manager: "./logs/manager.log"
        flask: "./logs/flask.log"
        camera: "./logs/camera.log"
        optimizer: "./logs/optimizer.log"
        applet: "./logs/applet.log"
      
      # Rotation
      rotation:
        max_bytes: 1048576        # 1 MB
        backup_count: 5
      
      # Console output
      console: true

    # -------------------------------------------------------------------------
    # Performance
    # -------------------------------------------------------------------------
    performance:
      num_threads: 4
      use_vectorized: true
      use_gpu: false              # Disable GPU for laptop
      
      # Memory limits
      max_memory_mb: 1024
      telemetry_buffer_size: 1000

    # -------------------------------------------------------------------------
    # Security
    # -------------------------------------------------------------------------
    security:
      enable_authentication: false
      require_https: false
      allowed_hosts:
        - "127.0.0.1"
        - "localhost"


  # ============================================================================
  # PRODUCTION PROFILE (Lab/Manager PC)
  # ============================================================================
  production:
    description: "Manager PC in lab (134.99.120.40)"

    # -------------------------------------------------------------------------
    # Network Configuration
    # -------------------------------------------------------------------------
    network:
      master_ip: "134.99.120.40"      # Manager PC
      bind_host: "0.0.0.0"            # All interfaces
      
      cmd_port: 5555
      data_port: 5556
      client_port: 5557
      camera_port: 5558
      
      connection_timeout: 5.0
      receive_timeout: 1.0
      heartbeat_interval: 10.0
      watchdog_timeout: 30.0
      
      max_retries: 5
      retry_base_delay: 1.0

    # -------------------------------------------------------------------------
    # Services Configuration
    # -------------------------------------------------------------------------
    services:
      flask:
        enabled: true
        host: "0.0.0.0"
        port: 5000
        threaded: true
        debug: false
      
      manager:
        enabled: true
        host: "0.0.0.0"
        max_worker_threads: 8
      
      camera:
        enabled: true
        host: "127.0.0.1"
        port: 5558
        auto_start: true            # Auto-start camera
        mode: "inf"
      
      optimizer:
        enabled: true
        host: "127.0.0.1"
        port: 5050
      
      applet:
        enabled: true
        host: "127.0.0.1"
        port: 5051

    # -------------------------------------------------------------------------
    # Data Paths
    # -------------------------------------------------------------------------
    paths:
      base: "Y:/Xi/Data"
      
      # Camera data (only two folders needed)
      jpg_frames: "E:/Data/jpg_frames"
      jpg_frames_labelled: "E:/Data/jpg_frames_labelled"
      
      experiments: "E:/Data/experiments"
      analysis: "E:/Data/analysis"
      
      logs: "E:/Data/logs"
      
      artiq_results: "C:/artiq-master/results"
      dac_settings: "artiq/Settings/DAC/2944_dac_diff_fits.json"

    # -------------------------------------------------------------------------
    # Hardware Settings
    # -------------------------------------------------------------------------
    hardware:
      defaults:
        ec1: 0.0
        ec2: 0.0
        comp_h: 0.0
        comp_v: 0.0
        u_rf_volts: 200.0
        piezo: 0.0
        freq0: 215.5
        freq1: 215.5
        amp0: 0.05
        amp1: 0.05
        sw0: 0
        sw1: 0
        bephi: 0
        b_field: 1
        be_oven: 0
        uv3: 0
        e_gun: 0
        sweep_target: 307
        sweep_span: 40.0
        sweep_att: 25.0
        sweep_on: 300.0
        sweep_off: 300.0
        sweep_points: 41
      
      camera:
        model: "C15550-20UP"
        sensor_size: [2048, 2048]
        bit_depth: 16
        cooling: -20.0
        
        exposure_ms: 300
        trigger_mode: "extern"      # External trigger for hardware
        max_frames: 100
        
        roi: [0, 500, 10, 300]
        
        processing:
          enabled: true
          filter_radius: 12
          threshold_sigma: 3.0
          max_ions: 10

    # -------------------------------------------------------------------------
    # LabVIEW Integration (Enabled in production)
    # -------------------------------------------------------------------------
    labview:
      enabled: true
      host: "172.17.1.217"          # SMILE PC
      port: 5559
      timeout: 5.0
      
      # Communication mode:
      # - true: Two-way, wait for response from LabVIEW
      # - false: One-way (fire-and-forget), LabVIEW only receives commands
      wait_for_response: false
      
      pressure_threshold_mbar: 5.0e-9
      pressure_check_interval: 0.05
      
      devices:
        - u_rf
        - piezo
        - be_oven
        - b_field
        - bephi
        - uv3
        - e_gun
        - hd_valve
        - dds

    # -------------------------------------------------------------------------
    # Wavemeter (HighFinesse WS7)
    # -------------------------------------------------------------------------
    wavemeter:
      enabled: true
      host: "134.99.120.141"
      port: 1790
      divider: 4.0
      
      fundamental_range: [200, 260]
      uv_range: [900, 980]
      
      display_unit: "GHz"
      precision: 3

    # -------------------------------------------------------------------------
    # Turbo/Optimizer Settings
    # -------------------------------------------------------------------------
    optimizer:
      turbo:
        max_iterations: 100
        batch_size: 1
        num_restarts: 10
        raw_samples: 512
        tr_length_init: 0.8
        tr_length_min: 0.01
        tr_length_max: 1.6
        failure_tolerance: 5
        success_tolerance: 3
      
      mobo:
        max_iterations: 50
        batch_size: 1
        num_restarts: 10
        raw_samples: 256
        ref_point: [0.0, 100.0]
        
      two_phase:
        phase1_iterations: 30
        phase2_iterations: 20
        warm_start: true

    # -------------------------------------------------------------------------
    # Applet Settings
    # -------------------------------------------------------------------------
    applet:
      auto_comp:
        enabled: true
        max_iterations: 50
        convergence_threshold: 0.01
      
      cam_sweep:
        enabled: true
        default_exposure_ms: 100
        default_frames: 10
      
      secular_sweep:
        enabled: true
        default_span_khz: 40
        default_steps: 41

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    logging:
      level: "INFO"
      format: "%(asctime)s - [%(name)s] - %(levelname)s - %(message)s"
      
      files:
        manager: "Y:/Xi/Data/logs/manager.log"
        flask: "Y:/Xi/Data/logs/flask.log"
        camera: "Y:/Xi/Data/logs/camera.log"
        optimizer: "Y:/Xi/Data/logs/optimizer.log"
        applet: "Y:/Xi/Data/logs/applet.log"
      
      rotation:
        max_bytes: 1048576
        backup_count: 5
      
      console: true

    # -------------------------------------------------------------------------
    # Performance
    # -------------------------------------------------------------------------
    performance:
      num_threads: 8
      use_vectorized: true
      use_gpu: true               # Enable GPU on server
      
      max_memory_mb: 4096
      telemetry_buffer_size: 1000

    # -------------------------------------------------------------------------
    # Security
    # -------------------------------------------------------------------------
    security:
      enable_authentication: true
      require_https: false
      allowed_hosts:
        - "134.99.120.40"
        - "localhost"
        - "127.0.0.1"
