# Lab Control Framework Configuration
# Centralized configuration for all components
# Updated: LabVIEW writes TDMS files to Y:/Xi/Data/PMT

---
network:
  # IP Addresses
  master_ip: "134.99.120.40"      # Camera/Master PC
  
  # ZMQ Ports
  cmd_port: 5555                  # Master -> Worker commands (PUB/SUB)
  data_port: 5556                 # Worker -> Master data (PUSH/PULL)
  client_port: 5557               # Flask -> Manager (REQ/REP)
  camera_port: 5558               # Camera server (TCP socket)
  
  # Timeouts (seconds)
  connection_timeout: 5.0
  receive_timeout: 1.0
  watchdog_timeout: 60.0
  heartbeat_interval: 10.0
  
  # Retry settings
  max_retries: 5
  retry_base_delay: 1.0

paths:
  # ARTIQ paths
  artiq_data: "C:/artiq-master/results"
  
  # ============================================================================
  # LABVIEW DATA DIRECTORY - Y:/Xi/Data (LabVIEW writes TDMS files here)
  # ============================================================================
  
  # Base output path - LabVIEW data location
  output_base: "Y:/Xi/Data"
  
  # LabVIEW TDMS data paths
  labview_tdms: "Y:/Xi/Data/PMT"                       # LabVIEW TDMS files
  labview_telemetry: "Y:/Xi/Data/telemetry"            # LabVIEW telemetry data
  
  # Camera paths - can be on local drive or network
  camera_frames: "Y:/Xi/Data/camera/raw_frames"        # Raw camera frames
  camera_settings: "Y:/Xi/Data/camera/settings"        # Camera configuration files
  camera_dcimg: "Y:/Xi/Data/camera/dcimg"              # DCIMG recordings
  live_frames: "Y:/Xi/Data/camera/live_frames"         # Live preview frames
  
  # Processed camera data
  jpg_frames: "E:/Data/jpg_frames"                     # Raw JPG frames from camera
  jpg_frames_labelled: "E:/Data/jpg_frames_labelled"   # Annotated/processed frames
  ion_data: "E:/Data/ion_data"                         # Ion position and fit data (JSON)
  
  # Experiment data
  experiments: "Y:/Xi/Data/experiments"                # Experiment metadata and results
  
  # Analysis data
  analysis_results: "Y:/Xi/Data/analysis/results"      # Analysis output
  analysis_settings: "Y:/Xi/Data/analysis/settings"    # Analysis configuration
  
  # Settings paths
  dac_settings: "artiq/Settings/DAC/2944_dac_diff_fits.json"
  
  # Debug paths
  debug_path: "Y:/Xi/Data/debug"

labview:
  # LabVIEW SMILE Interface Configuration
  enabled: true                 # Enable LabVIEW TCP communication
  host: "172.17.1.217"         # LabVIEW PC IP (SMILE computer)
  port: 5559                    # LabVIEW TCP listener port
  timeout: 5.0                  # Command timeout (seconds)
  retry_delay: 1.0              # Delay between retries (seconds)
  max_retries: 3                # Max retry attempts
  auto_reconnect: true          # Auto-reconnect on connection loss
  
  # Pressure Safety Configuration
  # If pressure exceeds this threshold, piezo and e-gun are immediately killed
  pressure_threshold_mbar: 5.0e-9    # 5 x 10^-9 mbar threshold
  pressure_check_interval: 0.05      # 20 Hz check rate (seconds)
  
  # Supported devices (must match LabVIEW implementation)
  # Note: u_rf is in mV (0-1400mV) before amplifier, U_RF is in V (0-200V) after amplifier
  # Scale: 700mV u_rf = 100V U_RF
  devices:
    - u_rf                      # RF voltage 0-1400mV (before amplifier)
    - piezo                     # Piezo voltage (0 to 4V)
    - be_oven                   # Be+ oven (0=off, 1=on)
    - b_field                   # B-field (0=off, 1=on)
    - bephi                     # Bephi (0=off, 1=on)
    - uv3                       # UV3 laser (0=off, 1=on)
    - e_gun                     # Electron gun (0=off, 1=on)
    - hd_valve                  # HD valve shutter (0=off, 1=on)
    - dds                       # DDS frequency control (0-200 MHz)

# Telemetry Data - LabVIEW writes files to shared drive
# Manager reads files from Y:/Xi/Data/telemetry/ into shared buffers
# Flask displays data from these buffers
# ARTIQ ndscan data comes via ZMQ (not files)
telemetry:
  enabled: true
  
  # Where LabVIEW saves data files
  path: "Y:/Xi/Data/telemetry"
  
  # Polling interval (seconds)
  poll_interval: 1.0
  
  # Expected directory structure:
  #   Y:/Xi/Data/telemetry/
  #   ├── wavemeter/*.dat      - CSV: timestamp,frequency_mhz
  #   ├── smile/pmt/*.dat      - CSV: timestamp,pmt_counts
  #   ├── smile/pressure/*.dat - CSV: timestamp,pressure_mbar
  #   └── camera/*.json        - JSON: pos_x, pos_y, sig_x, sig_y
  
  # TDMS files (LabVIEW writes to Y:/Xi/Data/PMT/)
  tdms_path: "Y:/Xi/Data/PMT"
  tdms_extension: ".tdms"
  
  # Buffer configuration
  max_points: 1000          # Max data points per channel
  window_seconds: 300       # 5 minute rolling window

hardware:
  # ARTIQ Worker defaults
  worker_defaults:
    # DC Defaults (Safe Mode)
    # Range: -1V to 50V for all electrodes
    ec1: 0.0
    ec2: 0.0
    comp_h: 0.0
    comp_v: 0.0
    
    # RF Voltage (real voltage U_RF in volts, after amplifier)
    # Note: LabVIEW sends u_rf in mV (0-1400mV), scale is 700mV = 100V
    u_rf_volts: 200.0
    
    # Piezo voltage for laser frequency tuning (0-4V range)
    piezo: 0.0
    
    # Cooling Parameters
    # Raman laser frequencies (MHz) - constants, backend only adjustment
    freq0: 215.5
    freq1: 215.5
    # Raman amplitudes (0-1)
    amp0: 0.05
    amp1: 0.05
    # Cooling shutters (0=off, 1=on)
    sw0: 0
    sw1: 0
    
    # Toggles (0=off, 1=on)
    bephi: 0
    b_field: 1
    be_oven: 0
    uv3: 0
    e_gun: 0
    
    # Sweep Defaults
    sweep_target: 307        # kHz
    sweep_span: 40.0         # Total span +/- 20kHz
    sweep_att: 25.0          # dB
    sweep_on: 300.0          # ms
    sweep_off: 300.0         # ms
    sweep_points: 41         # int

  # Camera settings
  camera:
    target_temperature: -20.0      # Celsius
    cooler_timeout: 300            # seconds
    max_frames_default: 100
    exposure_default: 0.3
    trigger_mode: "extern"         # "extern" or "software"
    
    # Subarray settings
    subarray:
      hsize: 300
      hpos: 1624
      vsize: 600
      vpos: 1396
    
    # Trigger delay (seconds)
    trigger_delay: 0.033138

# =============================================================================
# CAMERA CONTROL - Infinity Mode Activation
# =============================================================================
camera:
  # Auto-start camera when manager launches
  auto_start: true               # Start camera automatically on manager startup
  mode: "inf"                    # "inf" for infinite, "single" for DCIMG
  send_initial_trigger: true     # Send TTL trigger after starting
  
  # Camera server connection
  host: "127.0.0.1"
  port: 5558                     # TCP port for camera server
  
  # Frame paths (override paths.camera_* above)
  raw_frames_path: "E:/Data/jpg_frames"
  labelled_frames_path: "E:/Data/jpg_frames_labelled"
  ion_data_path: "E:/Data/ion_data"
  
  # Infinite mode settings
  infinite_mode:
    max_frames: 100              # Circular buffer size
    exposure_ms: 300
    trigger_mode: "software"     # "software" for auto-trigger, "extern" for TTL
  
  # Image processing settings
  processing:
    enabled: true
    roi: [180, 220, 425, 495]    # [x_start, x_finish, y_start, y_finish]
    filter_radius: 6
    threshold_sigma: 3.0         # Threshold for peak detection
    max_ions: 5                  # Maximum ions to detect per frame
  
  # HTTP API (Flask server)
  flask_base_url: "http://127.0.0.1:5000"

logging:
  level: "INFO"
  format: "%(asctime)s - [%(name)s] - %(levelname)s - %(message)s"
  file_rotation:
    max_bytes: 1048576      # 1MB
    backup_count: 5
  
  # Component log files (stored in Y:/Xi/Data/logs/)
  files:
    manager: "Y:/Xi/Data/logs/manager.log"
    worker: "Y:/Xi/Data/logs/artiq_worker.log"
    camera: "Y:/Xi/Data/logs/camera.log"
    analysis: "Y:/Xi/Data/logs/analysis.log"

analysis:
  # Sweep analysis
  sweep:
    model: "lorentzian"
    initial_guess:
      gamma: 5000.0          # 5 kHz

# =============================================================================
# IMAGE HANDLER CONFIGURATION - Ion Detection and Processing
# Optimized for: Intel Core Ultra 9 + NVIDIA Quadro P400
# =============================================================================
image_handler:
  # Region of Interest for ion detection [x_start, x_finish, y_start, y_finish]
  roi:
    x_start: 0
    x_finish: 500
    y_start: 10
    y_finish: 300
  
  # Detection Parameters (tunable)
  detection:
    threshold_percentile: 99.5    # Detect top 0.5% brightest spots (lower = more sensitive)
    min_snr: 6.0                  # Minimum signal-to-noise ratio
    min_intensity: 35             # Minimum peak intensity
    max_intensity: 65000          # Maximum intensity (saturated)
    min_sigma: 2.0                # Minimum Gaussian width (pixels)
    max_sigma: 30.0               # Maximum Gaussian width (pixels)
    max_ions: 10                  # Maximum ions to detect per frame
    min_distance: 15              # Minimum pixels between ions
    edge_margin: 20               # Reject ions within this margin of frame edges
    bg_kernel_size: 15            # Background subtraction kernel size
    scales: [3, 5, 7]             # Multi-scale filter sizes
  
  # Visualization Parameters (compact display)
  visualization:
    panel_height_ratio: 0.25      # Bottom panel height as ratio of image
    font_scale_title: 0.4         # Title/header font scale
    font_scale_data: 0.32         # Data values font scale
    font_scale_ion_num: 0.45      # Ion number label font scale
    crosshair_size: 12            # Half-length of crosshair lines (pixels)
    circle_radius_factor: 1.5     # Multiplier for sigma to get circle radius
  
  # Performance Parameters (Intel Core Ultra 9 optimized)
  performance:
    num_threads: 8                # Match Performance cores on Core Ultra 9
    use_vectorized: true          # Use NumPy vectorized operations
    use_gpu: true                 # Enable OpenCL/CUDA acceleration
    jpeg_quality: 85              # Output JPEG quality

experiment:
  # Experiment tracking
  auto_generate_id: true
  id_prefix: "EXP"
  save_metadata: true
  
  # Data retention
  max_frames_keep: 100     # Max frames in live folder
  cleanup_interval: 5      # seconds
