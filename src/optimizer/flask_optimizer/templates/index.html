{% extends "base.html" %}

{% block title %}Overview - Two-Phase BO Visualizer{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Two-Phase BO Overview</h1>
            <p class="text-gray-400 mt-1">Divide and Conquer experimental optimization for Be+/HD+ loading</p>
        </div>
        <div class="flex space-x-3">
            <button id="btn-start" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                <i class="fa-solid fa-play mr-2"></i>Start
            </button>
            <button id="btn-stop" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                <i class="fa-solid fa-stop mr-2"></i>Stop
            </button>
            <button id="btn-reset" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                <i class="fa-solid fa-rotate-left mr-2"></i>Reset
            </button>
        </div>
    </div>
    
    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Phase -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Current Phase</p>
                    <p id="status-phase" class="text-2xl font-bold text-white mt-1">--</p>
                </div>
                <div id="phase-icon" class="h-12 w-12 rounded-full bg-gray-700 flex items-center justify-center">
                    <i class="fa-solid fa-pause text-gray-400 text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- State -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">State</p>
                    <p id="status-state" class="text-2xl font-bold text-white mt-1">--</p>
                </div>
                <div class="h-12 w-12 rounded-full bg-gray-700 flex items-center justify-center">
                    <i class="fa-solid fa-circle-info text-gray-400 text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Iteration -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Iteration</p>
                    <p id="status-iteration" class="text-2xl font-bold text-blue-400 mt-1">--</p>
                </div>
                <div class="h-12 w-12 rounded-full bg-blue-900 flex items-center justify-center">
                    <i class="fa-solid fa-repeat text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Best Cost -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Best Cost</p>
                    <p id="status-cost" class="text-2xl font-bold text-green-400 mt-1">--</p>
                </div>
                <div class="h-12 w-12 rounded-full bg-green-900 flex items-center justify-center">
                    <i class="fa-solid fa-trophy text-green-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main content grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Configuration -->
        <div class="glass rounded-xl p-6">
            <h2 class="text-xl font-bold text-white mb-4">
                <i class="fa-solid fa-gear mr-2 text-blue-500"></i>Configuration
            </h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-2 border-b border-gray-700">
                    <span class="text-gray-400">Target Be+ Count</span>
                    <span id="config-be-count" class="text-white font-mono">--</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-700">
                    <span class="text-gray-400">Target HD+ Present</span>
                    <span id="config-hd-present" class="text-white font-mono">--</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-700">
                    <span class="text-gray-400">Max Iterations</span>
                    <span id="config-max-iter" class="text-white font-mono">--</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-700">
                    <span class="text-gray-400">Convergence Threshold</span>
                    <span id="config-threshold" class="text-white font-mono">--</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-400">Active Dimensions</span>
                    <span id="config-active-dims" class="text-white font-mono">--</span>
                </div>
            </div>
            
            <a href="/dashboard" class="mt-4 block w-full text-center bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg transition">
                <i class="fa-solid fa-chart-line mr-2"></i>Open Visualizer
            </a>
            <a href="/parameters" class="mt-2 block w-full text-center bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition">
                Edit Configuration
            </a>
        </div>
        
        <!-- Best Parameters -->
        <div class="glass rounded-xl p-6 lg:col-span-2">
            <h2 class="text-xl font-bold text-white mb-4">
                <i class="fa-solid fa-star mr-2 text-yellow-500"></i>Best Parameters
            </h2>
            
            <div id="best-params-container" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <p class="text-gray-500 col-span-full text-center py-8">No optimization data yet</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="glass rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
            <i class="fa-solid fa-bolt mr-2 text-yellow-500"></i>Quick Actions
        </h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="skipToPhase('be_loading')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition text-center">
                <i class="fa-solid fa-atom text-2xl mb-2 block text-blue-400"></i>
                Skip to Be+ Loading
            </button>
            <button onclick="skipToPhase('be_ejection')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition text-center">
                <i class="fa-solid fa-filter text-2xl mb-2 block text-orange-400"></i>
                Skip to Be+ Ejection
            </button>
            <button onclick="skipToPhase('hd_loading')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition text-center">
                <i class="fa-solid fa-plus text-2xl mb-2 block text-purple-400"></i>
                Skip to HD+ Loading
            </button>
            <button onclick="skipToPhase('complete')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition text-center">
                <i class="fa-solid fa-check text-2xl mb-2 block text-green-400"></i>
                Mark Complete
            </button>
        </div>
    </div>
    
    <!-- Real-time Plot -->
    <div class="glass rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">
            <i class="fa-solid fa-chart-line mr-2 text-green-500"></i>Cost History
        </h2>
        <div class="h-64">
            <canvas id="cost-chart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let costChart = null;
    
    // Initialize chart
    function initChart() {
        const ctx = document.getElementById('cost-chart').getContext('2d');
        costChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Cost',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Best Cost',
                    data: [],
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#9ca3af' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    }
                }
            }
        });
    }
    
    // Update UI with status
    function updateStatusUI(status) {
        // Phase
        const phaseEl = document.getElementById('status-phase');
        if (phaseEl) phaseEl.textContent = status.phase || 'idle';
        
        // Phase icon
        const phaseIcon = document.getElementById('phase-icon');
        if (phaseIcon) {
            const icons = {
                'idle': 'fa-pause',
                'be_loading': 'fa-atom',
                'be_ejection': 'fa-filter',
                'hd_loading': 'fa-plus',
                'complete': 'fa-check',
                'error': 'fa-exclamation-triangle'
            };
            const iconClass = icons[status.phase] || 'fa-pause';
            phaseIcon.innerHTML = `<i class="fa-solid ${iconClass} text-gray-400 text-xl"></i>`;
        }
        
        // State
        const stateEl = document.getElementById('status-state');
        if (stateEl) stateEl.textContent = status.state || '--';
        
        // Iteration
        const iterEl = document.getElementById('status-iteration');
        if (iterEl) iterEl.textContent = status.iteration !== undefined ? status.iteration : '--';
        
        // Cost
        const costEl = document.getElementById('status-cost');
        if (costEl) {
            costEl.textContent = status.best_cost !== undefined ? status.best_cost.toFixed(2) : '--';
        }
        
        // Active dimensions / Phase info
        const dimsEl = document.getElementById('config-active-dims');
        if (dimsEl) {
            if (status.active_dimensions) {
                dimsEl.textContent = status.active_dimensions.length;
            } else if (status.current_phase) {
                dimsEl.textContent = status.current_phase;
            }
        }
    }
    
    // Load configuration
    async function loadConfig() {
        try {
            const response = await apiRequest('/api/config');
            const config = response.data || response;
            
            // Handle both TwoPhaseController config and legacy config formats
            document.getElementById('config-be-count').textContent = 
                config.target_be_count !== undefined ? config.target_be_count : '--';
            document.getElementById('config-hd-present').textContent = 
                config.target_hd_present ? 'Yes' : (config.target_hd_present === false ? 'No' : '--');
            document.getElementById('config-max-iter').textContent = 
                config.turbo_max_iterations !== undefined ? config.turbo_max_iterations : 
                (config.max_iterations !== undefined ? config.max_iterations : '--');
            document.getElementById('config-threshold').textContent = 
                config.turbo_success_threshold !== undefined ? config.turbo_success_threshold : 
                (config.convergence_threshold !== undefined ? config.convergence_threshold : '--');
        } catch (e) {
            console.error('Failed to load config:', e);
        }
    }
    
    // Load best parameters
    async function loadBestParams() {
        try {
            const response = await apiRequest('/api/best');
            const params = response.data;
            
            if (!params) {
                document.getElementById('best-params-container').innerHTML = 
                    '<p class="text-gray-500 col-span-full text-center py-8">No optimization data yet</p>';
                return;
            }
            
            // Filter out metadata and format
            const excludeKeys = ['_time_windows', '_metadata'];
            const paramEntries = Object.entries(params)
                .filter(([key]) => !excludeKeys.some(ex => key.startsWith(ex)))
                .slice(0, 12);  // Show first 12 params
            
            const html = paramEntries.map(([key, value]) => `
                <div class="bg-gray-800 rounded-lg p-3">
                    <p class="text-gray-400 text-xs truncate">${key}</p>
                    <p class="text-white font-mono text-lg">${typeof value === 'number' ? value.toFixed(3) : value}</p>
                </div>
            `).join('');
            
            document.getElementById('best-params-container').innerHTML = html;
        } catch (e) {
            console.error('Failed to load best params:', e);
        }
    }
    
    // Load history for chart
    async function loadHistory() {
        try {
            const response = await apiRequest('/api/history');
            const history = response.data;
            
            if (!history || history.length === 0) return;
            
            const labels = history.map((h, i) => i + 1);
            const costs = history.map(h => h.cost);
            
            // Compute running best
            let bestSoFar = Infinity;
            const bestCosts = costs.map(c => {
                bestSoFar = Math.min(bestSoFar, c);
                return bestSoFar;
            });
            
            if (costChart) {
                costChart.data.labels = labels;
                costChart.data.datasets[0].data = costs;
                costChart.data.datasets[1].data = bestCosts;
                costChart.update();
            }
        } catch (e) {
            console.error('Failed to load history:', e);
        }
    }
    
    // Control buttons
    document.getElementById('btn-start')?.addEventListener('click', async () => {
        try {
            await apiRequest('/api/control/start', { method: 'POST' });
            showToast('Optimization started', 'success');
        } catch (e) {
            showToast('Failed to start optimization', 'error');
        }
    });
    
    document.getElementById('btn-stop')?.addEventListener('click', async () => {
        try {
            await apiRequest('/api/control/stop', { method: 'POST' });
            showToast('Optimization stopped', 'warning');
        } catch (e) {
            showToast('Failed to stop optimization', 'error');
        }
    });
    
    document.getElementById('btn-reset')?.addEventListener('click', async () => {
        try {
            await apiRequest('/api/control/reset', { method: 'POST' });
            showToast('Optimization reset', 'success');
            loadHistory();
        } catch (e) {
            showToast('Failed to reset optimization', 'error');
        }
    });
    
    // Skip to phase
    async function skipToPhase(phase) {
        try {
            await apiRequest(`/api/control/skip/${phase}`, { method: 'POST' });
            showToast(`Skipped to ${phase}`, 'success');
        } catch (e) {
            showToast('Failed to skip phase', 'error');
        }
    }
    
    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        loadConfig();
        loadBestParams();
        loadHistory();
        
        // Refresh data periodically
        setInterval(() => {
            loadBestParams();
            loadHistory();
        }, 5000);
    });
</script>
{% endblock %}
